"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.$expMovingAvg = void 0;
var util_1 = require("../../util");
var accumulator_1 = require("../accumulator");
var _internal_1 = require("./_internal");
/**
 * Returns the exponential moving average of numeric expressions applied to documents
 * in a partition defined in the $setWindowFields stage.
 */
function $expMovingAvg(_, collection, expr, options) {
    var _a = expr.inputExpr, input = _a.input, N = _a.N, alpha = _a.alpha;
    (0, util_1.assert)(!(N && alpha), "You must specify either N or alpha. You cannot specify both.");
    return (0, _internal_1.withMemo)(collection, expr, function () {
        var series = (0, accumulator_1.$push)(collection, input, options).filter(util_1.isNumber);
        return series.length === collection.length ? series : null;
    }, function (series) {
        // return null if there are incompatible values
        if (series === null)
            return null;
        // first item
        if (expr.documentNumber == 1)
            return series[0];
        var weight = N != undefined ? 2 / (N + 1) : alpha;
        var i = expr.documentNumber - 1;
        // update series with moving average
        series[i] = series[i] * weight + series[i - 1] * (1 - weight);
        return series[i];
    });
}
exports.$expMovingAvg = $expMovingAvg;
